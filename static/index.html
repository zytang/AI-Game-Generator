<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Game Generator | Create Educational Games in Seconds</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <meta name="description"
        content="Generate fully playable, educational HTML games in seconds using advanced AI. Just describe your idea and play instantly.">
</head>

<body>

    <div class="bg-decor"></div>

    <main class="container">
        <div class="glass-card">
            <div id="badge-container"></div>
            <h1>AI Game Generator</h1>
            <p class="subtitle">Turn your educational ideas into interactive experiences. <br> Powered by Gemini 2.5
                Pro.</p>

            <div class="input-wrapper">
                <textarea id="promptInput"
                    placeholder="Describe your game idea... (e.g., A level-based math quest for 10-year-olds with a space theme)"></textarea>
            </div>

            <div class="options-grid">
                <div class="option-group">
                    <label>Difficulty:</label>
                    <select id="difficultySelect">
                        <option value="easy">Easy (Beginner)</option>
                        <option value="medium" selected>Medium (Standard)</option>
                        <option value="hard">Hard (expert)</option>
                    </select>
                </div>
                <div class="option-group">
                    <label>Game Mode:</label>
                    <div class="toggle-switch">
                        <input type="checkbox" id="timerToggle" checked>
                        <label for="timerToggle">Timed Mode</label>
                    </div>
                </div>
            </div>

            <div class="button-group" style="display: flex; gap: 15px; margin-top: 25px;">
                <button id="genBtn" class="btn-generate" onclick="generateGame()" style="flex: 2;">Generate
                    Magic</button>
                <input type="file" id="importFile" accept=".html" style="display: none;"
                    onchange="handleImport(this.files)">
                <button id="importBtn" class="btn-import" onclick="document.getElementById('importFile').click()"
                    style="flex: 1; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); border-radius: 15px; color: white; cursor: pointer; font-weight: 600; font-size: 1.1rem; transition: all 0.3s ease;">
                    üìÇ Import
                </button>
                <button id="publishBtn" onclick="publishGame()"
                    style="display: none; flex: 1; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 15px; color: #ffd700; cursor: pointer; font-weight: 600; font-size: 1.1rem; transition: all 0.3s ease;">
                    ‚òÅÔ∏è Publish
                </button>
            </div>

            <div id="status" class="subtitle"></div>

            <div id="playSection" style="display:none;">
                <div class="qr-container">
                    <div id="qrcode"></div>
                    <p class="subtitle" style="margin-top: 15px; font-size: 0.9rem;">Scan to play on mobile</p>
                </div>

                <div class="action-buttons">
                    <button class="btn-play" onclick="playGame()">
                        <span style="font-size: 1.4rem;">‚ñ∂</span> Play Now
                    </button>
                    <a id="downloadLink" class="btn-secondary" style="display:none;" download>
                        <span>üíæ</span> Save HTML
                    </a>
                </div>
            </div>
        </div>
    </main>

    <script>
        let generatedGameUrl = "";
        const genBtn = document.getElementById("genBtn");
        const status = document.getElementById("status");
        const playSection = document.getElementById("playSection");
        const promptInput = document.getElementById("promptInput");
        const badgeContainer = document.getElementById("badge-container");
        const downloadLink = document.getElementById("downloadLink");
        const publishBtn = document.getElementById("publishBtn");
        let importedHtmlContent = "";

        async function generateGame() {
            let prompt = promptInput.value;
            const difficulty = document.getElementById("difficultySelect").value;
            const isTimed = document.getElementById("timerToggle").checked;

            if (!prompt.trim()) {
                showError("Please describe your game first!");
                return;
            }

            // UI Feedback
            genBtn.disabled = true;
            genBtn.textContent = "Igniting AI";
            status.innerHTML = "Consulting the digital oracle<span class='loading-dots'></span>";
            status.style.color = "var(--text-dim)";
            playSection.style.display = "none";
            badgeContainer.innerHTML = "";

            try {
                const response = await fetch("/generate-game", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        difficulty: difficulty,
                        is_timed: isTimed
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || "Generation failed");
                }

                generatedGameUrl = data.game_url;

                // Generate QR Code
                const origin = window.location.origin;
                const gamePath = generatedGameUrl.startsWith('/') ? generatedGameUrl : '/' + generatedGameUrl;
                const fullUrl = `${origin}${gamePath}`;

                generateQR(fullUrl);

                // Need to fetch the content so we can publish it immediately if desired
                try {
                    const contentRes = await fetch(generatedGameUrl);
                    if (contentRes.ok) {
                        importedHtmlContent = await contentRes.text();
                        publishBtn.style.display = "block";
                        publishBtn.textContent = "‚òÅÔ∏è Publish (Extend to 7 Days)";
                    }
                } catch (e) {
                    console.error("Failed to pre-fetch for publish:", e);
                }

                // Success State
                status.textContent = "Your world has been created!";
                status.style.color = "#00ff88";
                genBtn.disabled = false;
                genBtn.textContent = "Regenerate Magic";
                badgeContainer.innerHTML = '<span class="success-badge">‚ú® Artifact Forged Successfully</span>';

                // Set download link
                downloadLink.href = generatedGameUrl;
                downloadLink.download = generatedGameUrl.split('/').pop();
                downloadLink.style.display = "inline-flex";

                playSection.style.display = "block";

            } catch (error) {
                showError(error.message || "The AI encountered a glitch.");
                genBtn.disabled = false;
                genBtn.textContent = "Try Revision";
            }
        }

        function handleImport(files) {
            if (files.length === 0) return;

            const file = files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                const htmlContent = e.target.result;
                importedHtmlContent = htmlContent;
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');

                // 1. Extract Metadata
                const metaScript = doc.getElementById('game-metadata');
                let metaFound = false;

                if (metaScript) {
                    try {
                        const metadata = JSON.parse(metaScript.textContent);

                        // Populate Inputs
                        if (metadata.prompt) promptInput.value = metadata.prompt;
                        if (metadata.difficulty) document.getElementById("difficultySelect").value = metadata.difficulty;
                        if (typeof metadata.is_timed !== 'undefined') document.getElementById("timerToggle").checked = metadata.is_timed;

                        status.textContent = `Game Imported! Created: ${new Date(metadata.generated_at).toLocaleDateString()}`;
                        status.style.color = "#00d2ff";
                        metaFound = true;

                    } catch (err) {
                        console.error("Metadata parse error", err);
                    }
                }

                if (!metaFound) {
                    status.textContent = "Imported legacy game (No metadata found)";
                    status.style.color = "var(--text-dim)";
                }

                badgeContainer.innerHTML = '<span class="success-badge" style="background: rgba(0, 210, 255, 0.1); color: #00d2ff;">üìÇ Game Loaded</span>';

                // 2. Enable "Play Now" immediately with Blob URL
                const blob = new Blob([htmlContent], { type: 'text/html' });
                generatedGameUrl = URL.createObjectURL(blob);

                // Show Play Section
                playSection.style.display = "block";

                // Update QR to point to something? 
                // Since it's a blob URL, it won't work on mobile unless we upload it.
                // For now, let's just clear QR or show a message.
                const qrContainer = document.getElementById("qrcode");
                qrContainer.innerHTML = "<span style='font-size:0.8rem; opacity:0.7;'>Mobile play unavailable for local imports</span>";

                // Set download link to blob
                downloadLink.href = generatedGameUrl;
                downloadLink.download = file.name;
                downloadLink.style.display = "inline-flex";

                // Reset file input
                document.getElementById('importFile').value = '';

                // Show Publish Button
                publishBtn.style.display = "block";
            };

            reader.readAsText(file);
        }

        function generateQR(fullUrl) {
            const qrContainer = document.getElementById("qrcode");
            qrContainer.innerHTML = "";
            setTimeout(() => {
                try {
                    new QRCode(qrContainer, {
                        text: fullUrl,
                        width: 160,
                        height: 160,
                        colorDark: "#ffffff",
                        colorLight: "transparent",
                        correctLevel: QRCode.CorrectLevel.M
                    });
                } catch (e) {
                    console.error("QR Error", e);
                }
            }, 100);
        }

        function showError(msg) {
            status.textContent = msg;
            status.style.color = "#ff4d4d";
        }

        function playGame() {
            if (generatedGameUrl) {
                // Blob URLs are local and don't need cache busting (and don't support query params)
                if (generatedGameUrl.startsWith('blob:')) {
                    window.open(generatedGameUrl, "_blank");
                } else {
                    window.open(generatedGameUrl + "?t=" + Date.now(), "_blank");
                }
            }
        }

        // Add subtle focus effect
        promptInput.addEventListener('focus', () => {
            document.querySelector('.glass-card').style.boxShadow = "0 25px 50px rgba(0, 210, 255, 0.1)";
        });


        async function publishGame() {
            if (!importedHtmlContent) return;

            // UI Feedback
            publishBtn.disabled = true;
            publishBtn.textContent = "Publishing...";

            try {
                const response = await fetch("/publish-game", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        html_content: importedHtmlContent
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || "Publish failed");
                }

                // Update URL to the new server URL
                generatedGameUrl = data.game_url;
                const origin = window.location.origin;
                const gamePath = generatedGameUrl.startsWith('/') ? generatedGameUrl : '/' + generatedGameUrl;
                const fullUrl = `${origin}${gamePath}`;

                // Update QR Code
                generateQR(fullUrl);

                // Update Download Link logic? The blob is still fine for "Save HTML", but now we have a real URL.
                downloadLink.href = generatedGameUrl;

                // Success Feedback
                publishBtn.textContent = "‚úÖ Published!";
                status.textContent = "Game successfully published to cloud!";
                status.style.color = "#ffd700";

                // Hide publish button after a delay or keep as status
                setTimeout(() => {
                    publishBtn.style.display = "none";
                }, 2000);

            } catch (error) {
                showError("Publish failed: " + error.message);
                publishBtn.disabled = false;
                publishBtn.textContent = "‚òÅÔ∏è Publish Retry";
            }
        }
    </script>

</body>

</html>