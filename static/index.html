<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Game Generator | Create Educational Games in Seconds</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <meta name="description"
        content="Generate fully playable, educational HTML games in seconds using advanced AI. Just describe your idea and play instantly.">
</head>

<body>

    <div class="bg-decor"></div>

    <main class="container">
        <div class="glass-card">
            <div id="badge-container"></div>
            <h1>AI Game Generator</h1>
            <p class="subtitle">Turn your educational ideas into interactive experiences. <br> Powered by Gemini 2.5
                Pro. Support Shared Leaderboards!</p>

            <div class="input-wrapper">
                <textarea id="promptInput"
                    placeholder="Describe your game idea... (e.g., A level-based math quest for 10-year-olds with a space theme)"></textarea>
            </div>

            <button id="genBtn" class="btn-generate" onclick="generateGame()">Generate Magic</button>

            <div id="status" class="subtitle"></div>

            <div id="playSection" style="display:none;">
                <div class="qr-container">
                    <div id="qrcode"></div>
                    <p class="subtitle" style="margin-top: 15px; font-size: 0.9rem;">Scan to play on mobile</p>
                </div>

                <button class="btn-play" onclick="playGame()">
                    <span style="font-size: 1.4rem;">▶</span> Play on this Device
                </button>
            </div>
        </div>
    </main>

    <script>
        let generatedGameUrl = "";
        const genBtn = document.getElementById("genBtn");
        const status = document.getElementById("status");
        const playSection = document.getElementById("playSection");
        const promptInput = document.getElementById("promptInput");
        const badgeContainer = document.getElementById("badge-container");

        async function generateGame() {
            const prompt = promptInput.value;

            if (!prompt.trim()) {
                showError("Please describe your game first!");
                return;
            }

            // UI Feedback
            genBtn.disabled = true;
            genBtn.textContent = "Igniting AI";
            status.innerHTML = "Consulting the digital oracle<span class='loading-dots'></span>";
            status.style.color = "var(--text-dim)";
            playSection.style.display = "none";
            badgeContainer.innerHTML = "";

            try {
                const response = await fetch("/generate-game", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ prompt })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || "Generation failed");
                }

                generatedGameUrl = data.game_url;

                // Generate QR Code
                const origin = window.location.origin;
                // Clean double slashes just in case, though usually not needed if backend returns /games/...
                const gamePath = generatedGameUrl.startsWith('/') ? generatedGameUrl : '/' + generatedGameUrl;
                const fullUrl = `${origin}${gamePath}`;

                const qrContainer = document.getElementById("qrcode");
                qrContainer.innerHTML = ""; // Clear previous

                // Debug log
                console.log("Generating QR for:", fullUrl);

                // Small delay to ensure container is rendered
                setTimeout(() => {
                    try {
                        new QRCode(qrContainer, {
                            text: fullUrl,
                            width: 160,
                            height: 160,
                            colorDark: "#ffffff",
                            colorLight: "#000000", /* Changed to black background for better contrast if transparent fails? No, keep transparent but ensure colorDark is visible */
                            colorLight: "transparent",
                            correctLevel: QRCode.CorrectLevel.M // Lower correction level makes it less dense/easier to scan
                        });
                    } catch (e) {
                        console.error("QR Code generation error:", e);
                        qrContainer.textContent = "Error generating QR code";
                    }
                }, 100);

                // Success State
                status.textContent = "Your world has been created!";
                status.style.color = "#00ff88";
                genBtn.disabled = false;
                genBtn.textContent = "Regenerate Magic";
                badgeContainer.innerHTML = '<span class="success-badge">✨ Artifact Forged Successfully</span>';
                playSection.style.display = "block";

            } catch (error) {
                showError(error.message || "The AI encountered a glitch.");
                genBtn.disabled = false;
                genBtn.textContent = "Try Revision";
            }
        }

        function showError(msg) {
            status.textContent = msg;
            status.style.color = "#ff4d4d";
        }

        function playGame() {
            if (generatedGameUrl) {
                window.open(generatedGameUrl + "?t=" + Date.now(), "_blank");
            }
        }

        // Add subtle focus effect
        promptInput.addEventListener('focus', () => {
            document.querySelector('.glass-card').style.boxShadow = "0 25px 50px rgba(0, 210, 255, 0.1)";
        });
        promptInput.addEventListener('blur', () => {
            document.querySelector('.glass-card').style.boxShadow = "0 25px 50px rgba(0, 0, 0, 0.3)";
        });
    </script>

</body>

</html>